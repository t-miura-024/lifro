# アーキテクチャ設計

## 全体アーキテクチャ

本システムは Next.js を採用したモノリシックなアプリケーションとして構築します。
Next.js の App Router を活用し、SSR（Server-Side Rendering）と CSR を適切に使い分けることで、
パフォーマンスと開発効率の両立を図ります。

## フロントエンド

フロントエンドはコロケーションパターンを採用します。コンポーネントとそれに関連するロジック・スタイルを
同じディレクトリに配置することで、関連する機能の保守性を高めます。
全てのコンポーネントは app 配下に配置し、機能固有のコンポーネントはその機能のディレクトリに配置します。
コンポーネントは全て\_components という名前のプライベートディレクトリに配置します。

### ディレクトリ構成

```
src/app/
├── _components/             # アプリケーション全体で共通のコンポーネント
├── api/                     # API Routes (認証のみ)
│   └── auth/                # NextAuth.js のハンドラー
├── (public)/                # 未認証でもアクセス可能なルートグループ
│   ├── _components/         # 公開画面共通のコンポーネント
│   ├── login/               # ログイン画面
│   │   ├── _components/     # ログイン画面専用コンポーネント
│   │   ├── page.tsx         # ログインページコンポーネント
│   │   └── ...
│   ├── layout.tsx           # 公開ページの共通レイアウト
│   └── ...                  # ディレクトリはドメイン単位
├── (protected)/             # 認証が必要なルートグループ
│   ├── _components/         # 認証済みページ共通のコンポーネント
│   ├── logs/                # ログ管理画面
│   │   ├── _actions/        # ログ機能の Server Actions
│   │   ├── _components/     # ログ管理画面専用コンポーネント
│   │   ├── page.tsx         # ログ管理ページコンポーネント
│   │   └── ...
│   ├── statistics/          # 統計ダッシュボード画面
│   │   ├── _actions/        # 統計機能の Server Actions
│   │   ├── _components/     # 統計画面専用コンポーネント
│   │   ├── page.tsx         # 統計ページコンポーネント
│   │   └── ...
│   ├── settings/            # 設定画面
│   │   ├── _components/     # 設定画面専用コンポーネント
│   │   └── page.tsx         # 設定ページコンポーネント
│   ├── layout.tsx           # 認証済みページの共通レイアウト
│   └── ...                  # ディレクトリはドメイン単位
└── providers/               # コンテキストプロバイダー
```

## PWA

本アプリケーションは PWA（Progressive Web App）に対応しています。
@serwist/next を使用して Service Worker を構成し、オフライン対応とインストール機能を提供します。

### 機能概要

- **ホーム画面へのインストール**: カスタム UI でユーザーにインストールを促進
- **オフライン閲覧**: キャッシュされたデータをオフライン時に表示
- **App Shell キャッシュ**: 静的アセットをプリキャッシュして高速表示

### キャッシュ戦略

| リソース | 戦略 | 説明 |
|---------|------|------|
| App Shell (JS/CSS) | Precache | ビルド時にプリキャッシュ |
| HTML | Network First | 最新優先、オフライン時はキャッシュから |
| API レスポンス | Network First | データの鮮度を優先 |
| 静的アセット | Cache First | 変更頻度が低いため |
| Google Fonts | Cache First | CDN、変更なし |

### ディレクトリ構成

```
src/
├── app/
│   ├── sw.ts              # Service Worker 定義
│   ├── manifest.ts        # Web App Manifest
│   └── offline/           # オフラインフォールバックページ
├── components/
│   └── pwa/
│       └── InstallPrompt.tsx  # インストール促進 UI
└── hooks/
    └── usePwaInstall.ts   # インストール状態管理 Hook

public/
├── icons/                 # アプリアイコン (192x192, 512x512, maskable)
└── screenshots/           # インストール UI 用スクリーンショット
```

### インストール UI

- `beforeinstallprompt` イベントをキャッチしてカスタム UI を表示
- 一度閉じたユーザーには 7 日間非表示
- インストール済み（standalone モード）の場合は非表示

## データ操作方式

本システムでは **Server Actions** を採用し、クライアントからサーバーへのデータ操作を行います。
Route Handlers (API Routes) は認証処理（NextAuth.js）のみに限定します。

### Server Actions の配置

Server Actions は機能ごとにコロケーションパターンで配置します：

```
src/app/(protected)/logs/
├── _actions/
│   ├── training.ts      # トレーニング関連の Server Actions
│   ├── exercise.ts      # 種目関連の Server Actions
│   └── index.ts         # re-export
├── _components/
└── page.tsx
```

### 認証チェック

Server Actions 内では `getServerAuthSession()` を使用してユーザー認証を確認し、
認証済みユーザーの ID を取得します。

## バックエンド

バックエンドはレイヤードアーキテクチャを採用します。
ただし、Infrastructure 層と Application 層間の依存は DI により依存性を逆転させることとします。
プレゼンテーション層は Server Actions が担当するため、サーバーサイドのディレクトリ構成には含めません。

### ディレクトリ構成

```
src/server/
├── application/            # アプリケーション層
│   └── services/           # アプリケーションサービス
├── domain/                 # ドメイン層
│   ├── entities/           # エンティティ（型定義）
│   └── repositories/       # リポジトリインターフェース
└── infrastructure/         # インフラストラクチャ層
    ├── cache/              # キャッシュ関連
    │   └── CacheService.ts # Redis キャッシュサービス
    ├── database/           # データベース関連
    │   └── prisma/         # Prisma Client
    └── repositories/       # リポジトリ実装
        └── prisma/         # Prisma を用いた実装
```

### レイヤー間の依存関係

```
Server Actions
      ↓
Application Services (trainingService, exerciseService, statisticsService)
      ↓                    ↓
Repository Interfaces      CacheService (Redis)
      ↑
Prisma Repositories (実装)
```

### キャッシュ戦略

- 参照系データは Redis キャッシュ（TTL 5分）で高速化
- データ更新時は関連キャッシュを自動的に無効化し、データ整合性を保証
- キャッシュキー形式: `lifro:{userId}:{domain}:{method}:{params}`
