# 認証基盤

本システムの認証は NextAuth v4 と PrismaAdapter を採用します。セッションはデータベース戦略を採用し、Neon(PostgreSQL) 上の `sessions` テーブルで管理します。IdP はまず Google OAuth をサポートし、必要に応じて拡張可能です。

## 採用技術
- NextAuth v4
- Prisma + `@next-auth/prisma-adapter`
- Provider: Google
- DB セッション戦略

## ルーティング/構成
- 設定: `src/auth.ts` (`authOptions`, `getServerAuthSession`)
- Route Handlers: `src/app/api/auth/[...nextauth]/route.ts`
- 公開ページ: `src/app/(public)/login/page.tsx`
- 保護レイアウト: `src/app/(protected)/layout.tsx` (未ログイン時 `/login` にリダイレクト)

## セッション方針
- `strategy: "database"` を採用。サーバー側でセッション失効/取り消しが可能。
- `session.user.id` を拡張して付与。

## DB スキーマ
- 既存 `users` に `email_verified` を追加。
- NextAuth 用: `accounts`, `sessions`, `verification_tokens` を追加。
- Prisma スキーマ: `prisma/schema.prisma` を参照。

## 環境変数
- `DATABASE_URL`: Neon 接続文字列
- `NEXTAUTH_SECRET`: セッション署名用の秘密鍵
- `NEXTAUTH_URL`(任意): デプロイ URL
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`: Google OAuth クライアント情報

## 画面
- ログイン: Google でのシングルサインオンボタンを提供
- ログアウト: `(protected)/_components/LogoutButton.tsx`

## 権限とガード
- 認証必須ページは `(protected)` 直下に配置し、`ProtectedLayout` が SSR で `getServerAuthSession()` を評価してリダイレクト。
- API Route でユーザー識別が必要な場合は `import { getServerAuthSession } from "@/auth"` を用いてサーバー側でセッションを参照。

## セキュリティ
- HTTPS/`NEXTAUTH_SECRET` 必須。
- セッションは DB 保管でサーバー側制御。
- 機密値は `.env` で管理し、ログ出力しない。

## 導入手順
1. 依存インストール: `bun add next-auth @next-auth/prisma-adapter`
2. Prisma 生成: `bun run db:generate`
3. マイグレーション適用: `bun run db:migrate -- --name add_auth_models`
4. Google OAuth クライアントを発行し、`.env` に `GOOGLE_CLIENT_ID/SECRET` を設定
5. 開発起動: `bun run dev`
