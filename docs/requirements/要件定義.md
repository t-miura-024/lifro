# 要件定義

## 機能要件

### ログ機能
- ユーザーが筋トレの成果を入力できる。
  - 種目
  - 重量
  - レップ数
- 種目、重量、レップ数をまとめてセットとして入力できる。
  - 入力前は前回の入力値を表示する。
  - 入力後は前回の入力値との差分を表示する。
  - 種目名は登録済みの種目からプルダウンで選択できる。
- トレーニングの概念
  - トレーニングはセットを日単位でまとめた概念であり、セットの二次情報である。
  - 複数のセットが同じ日に行われた場合、それらは同一のトレーニングとして扱われる。
- トレーニング（セットのグループ）を日付で入力できる。
  - カレンダーから日付を選択できる。
  - 過去の日付にさかのぼって入力できる。
- 入力済みログの管理
  - 記録の編集・削除ができる。
- トレーニングメモ
  - トレーニング（日単位）に対して複数のメモを入力できる。
  - メモはログ作成・編集画面で入力・編集・削除できる。
  - ログ一覧画面ではメモの有無がアイコンで表示される。
  - アイコンをクリックするとポップオーバーでメモ内容を確認できる。
- 前回値・差分の定義
  - 前回値は「前回のトレーニング（前回の日付）における同一種目の最後のセットの重量・レップ数」とする。
  - 差分は、現在入力中のセット値と前回値との差（重量・レップ数ごと）を表示する。

### 種目管理機能
- ユーザーが種目情報を管理できる。
  - 種目の一覧表示ができる。
    - 種目は主要部位（負荷割合が最も高い部位）のカテゴリでグループ化して表示される。
    - 部位未設定の種目は「未分類」グループに表示される。
  - 種目の新規作成ができる。
  - 種目名の編集ができる。
  - 種目の削除ができる。
    - トレーニング記録が紐づいている種目は削除できない。
  - 種目の並び順をドラッグ&ドロップで変更できる。
    - 並び順は同一カテゴリ内でのみ変更可能。
    - 並び順はログ入力時の種目選択プルダウンに反映される。
- 種目に部位情報を紐付けできる。
  - 各種目に複数の部位を割り当てることができる。
  - 各部位に対して負荷割合（0-100%）を設定できる。
    - 負荷割合の合計は100%になる必要がある。
  - 部位マスタは以下の大カテゴリ・小カテゴリで構成される。
    - 胸: 上部、中部、下部
    - 背中: 広背筋、僧帽筋、脊柱起立筋
    - 肩: 前部、中部、後部
    - 腕: 二頭筋、三頭筋、前腕筋
    - 腹筋: 上部、下部、横腹
    - 脚: 太もも前、太もも裏、臀部、ふくらはぎ

### 統計機能
- 入力された筋トレの成果をグラフィカルに表示するダッシュボードを提供する。
- 画面構成
  - タブ切り替え（ボリューム / 重量 / 継続）で指標を整理する。
  - グローバルフィルターで全タブ共通の時間粒度・時間範囲を指定できる。
- グローバルフィルター
  - 時間粒度: 日 / 週 / 月をトグルボタンで切り替える。
  - 時間範囲: プリセット（過去1ヶ月 / 3ヶ月 / 6ヶ月 / 1年 / 全期間）またはカスタム日付を選択できる。
- ボリュームタブ
  - KPIカード: 選択期間の合計ボリューム（全種目）を表示する。
  - 部位別リスト: 部位ごとの合計ボリュームをリスト形式で表示する（ボリューム降順）。
    - カテゴリ単位/部位単位で切り替えて表示できる。
    - 部位別ボリュームは負荷割合で按分計算される。
  - 種目別リスト: 種目ごとの合計ボリュームをリスト形式で表示する（ボリューム降順）。
  - 推移グラフ: 積み上げ棒グラフで種目別に色分けし、ホバー時にセット数を表示する。
- 重量タブ
  - 最大重量グラフ: 種目を選択し、棒グラフで期間ごとの最大重量を表示する。
  - 1RMグラフ: 種目を選択し、棒グラフで期間ごとの推定1RMを表示する。
- 継続タブ
  - KPIカード: 合計トレーニング日数 / 連続継続月数 / 連続継続週数を表示する。
  - 推移グラフ: 棒グラフで期間ごとのトレーニング日数を表示する。
  - 種目別リスト: 種目ごとのトレーニング日数をリスト形式で表示する（日数降順）。
  - 部位別リスト: 部位ごとのトレーニング日数をリスト形式で表示する（日数降順）。
    - カテゴリ単位/部位単位で切り替えて表示できる。
- 指標の定義
  - ボリューム = weight × reps（セット単位で計算し合算）
  - 部位別ボリューム = weight × reps × load_ratio / 100（負荷割合で按分）
  - 最大重量 = 指定期間内の各種目のセット重量の最大値
  - 1RM = 最大重量 × (1 + レップ数 / 29.5)
  - 連続継続月数 = 1回以上トレーニング記録がある月が連続している月数（未記録月でリセット）
  - 連続継続週数 = 1回以上トレーニング記録がある週が連続している週数（未記録週でリセット）

### タイマー機能
- トレーニング中のインターバル管理のためのタイマー機能を提供する。
- データ構造
  - タイマー: ユニットタイマーの集合体
    - タイマー名
    - ソートインデックス（並び順）
  - ユニットタイマー: タイマーを構成する個々の時間単位
    - 時間（秒単位）
    - カウント音（プリセットから選択）
    - 終了3秒前の音（プリセットから選択）
    - 終了音（プリセットから選択）
- タイマー管理
  - タイマー一覧画面でタイマーの作成・編集・削除ができる。
  - タイマーの並び順をドラッグ&ドロップで変更できる。
  - タイマー詳細モーダルでユニットタイマーの追加・編集・削除ができる。
- タイマー実行
  - タイマー一覧画面から直接タイマーを開始できる。
  - ログ入力モーダルからタイマーを選択して開始できる。
  - 操作: 再生 / 一時停止 / 再開 / 停止
  - 複数のユニットタイマーは順番に自動実行される（1つ完了後、次が自動開始）。
  - タイマーは1回実行で終了（リピートなし）。
- タイマー実行オーバーレイ
  - タイマー再生中または一時停止中は画面上部にオーバーレイを表示する。
  - どの画面においてもタイマーの進捗状況の確認と操作が可能。
  - 表示内容: タイマー名、現在のユニット番号、残り時間、プログレスバー
  - 操作ボタン: 再生/一時停止トグル、停止
- 音声
  - `public/sounds/` フォルダ内の音声ファイルを動的に読み込み、選択肢として表示。
  - 対応形式: MP3, WAV, OGG
  - ユニットタイマーごとにカウント音・終了3秒前の音・終了音を設定可能。
  - DBにはファイル名（拡張子付き）を保存。

### 認証機能
- Googleアカウントを利用した認証機能を提供する。
  - ユーザーがGoogleアカウントでログインできるようにする。
  - ログイン状態を維持できる。
  - ログアウト機能を提供する。

## 非機能要件

### ユーザビリティ
- シンプルで直感的なUIを提供し、ユーザーが迷わずに操作できるようにする。
  - 重要な機能へのアクセスは3タップ以内で可能にする。
  - 入力フォームは自動補完機能を備える。
  - エラーメッセージは具体的で分かりやすい内容にする。
- ローディング表示はスケルトンローディングで統一する。
  - データ取得中はコンテンツの形状に合わせたスケルトンを表示し、レイアウトシフトを防止する。
  - ユーザーがコンテンツの構造を予測でき、体感待ち時間を短縮する。
- モバイルデバイスでも快適に操作できるレスポンシブデザインを採用する。
  - 標準画面は Pixel 9（1080×2424）。論理解像度約 411×915dp を基準に最適化する。
  - ビューポートは `width=device-width, initial-scale=1, viewport-fit=cover` を設定する。
  - タッチターゲットは 44dp 以上とする（ボタン、アイコンボタン）。
  - 片手操作（親指リーチ）を考慮し、主要アクションは画面下部または右上に配置する。
  - セーフエリア（ノッチ/ホームインジケータ）を考慮し、`100dvh` とパディングで吸収する。
- トレーニング中の片手操作に対応したUIを提供する。
  - 大きなボタンやスワイプ操作など、トレーニング中でも操作しやすい設計にする。

### セキュリティ
- ユーザーのデータを安全に保存し、第三者からの不正アクセスを防ぐ。
  - すべての通信はHTTPS経由で行う。
  - 個人情報は適切に暗号化して保存する。
- ユーザー認証機能を実装し、データのプライバシーを保護する。
  - 認証トークンの有効期限を適切に設定する。
  - セッション管理を適切に行い、不正なアクセスを防止する。

### パフォーマンス
- 参照系データはRedisキャッシュ（TTL 5分）で高速化する。
- データ更新時は関連キャッシュを自動的に無効化し、データ整合性を保証する。

### PWA対応
- ホーム画面へのインストールをサポートする。
  - Web App Manifest を提供し、ネイティブアプリのような体験を実現する。
  - カスタム UI でユーザーにインストールを促す。
  - 一度閉じたユーザーには一定期間（7日間）非表示にする。
- オフライン時でも過去のデータを閲覧できる。
  - Service Worker によるキャッシュ戦略を実装する。
  - オフライン時はキャッシュからデータを表示する。
  - 未キャッシュのページにアクセスした場合はオフラインページを表示する。
