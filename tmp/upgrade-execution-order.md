# アップグレード実行順序と依存関係

## 概要

本ドキュメントでは、各ライブラリのアップグレード間の依存関係と推奨実行順序をまとめています。

## 依存関係図

```
┌─────────────────────────────────────────────────────────────────────┐
│                        アップグレード依存関係図                        │
└─────────────────────────────────────────────────────────────────────┘

     ┌──────────────────┐      ┌──────────────────┐
     │  @types/node v25 │      │    Biome v2      │
     │   + engines設定   │      │  （独立・開発ツール）│
     │     [順序: 1]     │      │    [順序: 2]     │
     └────────┬─────────┘      └──────────────────┘
              │
              │ Node.js バージョン要件
              ▼
     ┌──────────────────┐
     │  Auth Adapter    │
     │     移行         │
     │    [順序: 3]     │
     └────────┬─────────┘
              │
              │ Prisma インポート変更前に完了
              ▼
     ┌──────────────────┐
     │  Next.js v16     │
     │    [順序: 4]     │
     └────────┬─────────┘
              │
              │ ESM 対応プロジェクトで実行
              ▼
     ┌──────────────────┐
     │   Prisma v7      │
     │  （ESM化が必須）   │
     │    [順序: 5]     │
     └──────────────────┘
```

## 推奨実行順序

### 順序 1: @types/node v25 + engines 設定

| 項目 | 内容 |
|------|------|
| 計画書 | [upgrade-types-node-v25.md](./upgrade-types-node-v25.md) |
| 依存 | なし |
| 理由 | 他のアップグレードの前提となる Node.js バージョン要件を設定 |

**この段階で行うこと:**
- `@types/node` を v25.0.10 にアップグレード
- `package.json` に `engines` フィールドを追加

```json
{
  "engines": {
    "node": ">=20.19.0"
  }
}
```

---

### 順序 2: Biome v2

| 項目 | 内容 |
|------|------|
| 計画書 | [upgrade-biome-v2.md](./upgrade-biome-v2.md) |
| 依存 | なし |
| 理由 | 開発ツールのため本番環境に影響なし、独立して実行可能 |

**この段階で行うこと:**
- `@biomejs/biome` を v2.3.11 にアップグレード
- `bunx @biomejs/biome migrate --write` で設定を自動移行

**並行実行:** 順序 1 と同時に実行可能

---

### 順序 3: Auth Adapter 移行

| 項目 | 内容 |
|------|------|
| 計画書 | [migrate-auth-adapter.md](./migrate-auth-adapter.md) |
| 依存 | なし（ただし Prisma v7 の前に推奨） |
| 理由 | Prisma v7 でインポートパスが変わるため、先に移行しておくとシンプル |

**この段階で行うこと:**
- `src/auth.ts` のインポート元を `@auth/prisma-adapter` に変更
- `@next-auth/prisma-adapter` を削除

---

### 順序 4: Next.js v16

| 項目 | 内容 |
|------|------|
| 計画書 | [upgrade-nextjs-v16.md](./upgrade-nextjs-v16.md) |
| 依存 | Node.js 20.9+ |
| 理由 | フレームワークの更新、Turbopack がデフォルトに |

**この段階で行うこと:**
- `next` を v16.1.4 にアップグレード
- `--turbopack` フラグを削除
- 関連パッケージの互換性確認

---

### 順序 5: Prisma v7

| 項目 | 内容 |
|------|------|
| 計画書 | [upgrade-prisma-v7.md](./upgrade-prisma-v7.md) |
| 依存 | Node.js 20.19+, TypeScript 5.4+, ESM 化 |
| 理由 | プロジェクト全体に ESM 化の影響があるため最後に実行 |

**この段階で行うこと:**
- `package.json` に `"type": "module"` を追加
- `prisma/schema.prisma` の generator 設定を更新
- 全 Prisma インポートパスを更新
- Prisma Client を再生成

## 並行実行可能な組み合わせ

以下のアップグレードは同時に実行可能です：

### パターン A: 最速アプローチ

```
┌───────────────────────────────┐
│ 同時実行:                     │
│ - @types/node v25            │
│ - Biome v2                   │
│ - Auth Adapter 移行           │
└───────────────────────────────┘
              │
              ▼
┌───────────────────────────────┐
│ 同時実行:                     │
│ - Next.js v16                │
│ - Prisma v7                  │
│ （ESM 化を同時に対応）         │
└───────────────────────────────┘
```

### パターン B: 安全アプローチ（推奨）

```
順序 1 → 順序 2 → 順序 3 → 順序 4 → 順序 5
（1つずつ確認しながら進める）
```

## 各ステップのテスト観点

### 順序 1 完了後

- [ ] `bun run build` が成功すること
- [ ] Vercel にデプロイして Node.js バージョンが正しいこと

### 順序 2 完了後

- [ ] `bun run lint` が成功すること
- [ ] `bun run format` が成功すること
- [ ] `bun run check` が成功すること

### 順序 3 完了後

- [ ] `bun run build` が成功すること
- [ ] ログイン機能が正常に動作すること
- [ ] セッション管理が正常に動作すること

### 順序 4 完了後

- [ ] `bun run dev` が正常に起動すること
- [ ] `bun run build` が成功すること
- [ ] 全ページが正常に表示されること
- [ ] PWA 機能が動作すること

### 順序 5 完了後

- [ ] `bun run db:generate` が成功すること
- [ ] `bun run build` が成功すること
- [ ] 全 CRUD 操作が正常に動作すること
- [ ] トランザクションが正常に動作すること
- [ ] Raw クエリが正常に動作すること

## ロールバック手順

各アップグレードで問題が発生した場合のロールバック手順：

### Git を使用したロールバック

各アップグレードは個別のコミットで行い、問題発生時は以下でロールバック：

```bash
git revert HEAD
bun install
```

### パッケージバージョンの固定

問題が発生したパッケージを元のバージョンに戻す：

```bash
# 例: Prisma を v5 に戻す
bun add @prisma/client@5.16.1
bun add -D prisma@5.16.1
```

## タイムライン目安

| 順序 | アップグレード | 所要時間目安 |
|-----|--------------|------------|
| 1 | @types/node v25 | 15分 |
| 2 | Biome v2 | 15分 |
| 3 | Auth Adapter 移行 | 30分 |
| 4 | Next.js v16 | 1時間 |
| 5 | Prisma v7 | 2時間 |

**合計:** 約 4 時間（テスト込み）

## 注意事項

1. **バックアップ**: 各アップグレード前に Git でコミットを作成
2. **ステージング環境**: 可能であれば本番適用前にステージング環境でテスト
3. **依存パッケージ**: アップグレード時に他のパッケージも更新が必要になる可能性あり
4. **破壊的変更**: 各計画書の破壊的変更セクションを必ず確認
5. **ESM 化**: Prisma v7 の ESM 化は影響範囲が広いため、十分なテストを実施

## 関連ドキュメント

- [upgrade-prisma-v7.md](./upgrade-prisma-v7.md)
- [upgrade-types-node-v25.md](./upgrade-types-node-v25.md)
- [upgrade-biome-v2.md](./upgrade-biome-v2.md)
- [upgrade-nextjs-v16.md](./upgrade-nextjs-v16.md)
- [migrate-auth-adapter.md](./migrate-auth-adapter.md)
